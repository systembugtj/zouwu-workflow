# Zouwu Workflow 项目规范与代码标准

## 核心原则

### 沟通方式

- 所有回答使用中文（对话和思考过程）
- 仅模式声明和代码块使用英文

### 问题解决

- 每个问题至少提供 2 个不同的解决方案
- AI 自动选择并执行最优方案
- 用户可随时纠错
- 修复问题，绝不跳过或绕过

## 代码标准

### 文件大小限制

- 类文件：最多 200 行
- 函数文件：最多 150 行
- 单个函数：最多 50 行
- 最大嵌套层级：3 层

### 纯函数优先（Linus 风格）

```typescript
// ✅ 推荐：纯函数，职责单一
function validateConfig(config: unknown): ValidationResult {
    if (!config || typeof config !== 'object') {
        return { valid: false, error: '无效配置' };
    }
    return { valid: true, data: config };
}

function transformData(data: ValidData): TransformedData {
    return {
        ...data,
        timestamp: Date.now(),
    };
}

// ❌ 避免：大型类，职责混乱
class DataProcessor {
    processData() {
        /* 200+ 行 */
    }
    validateData() {
        /* 100+ 行 */
    }
    transformData() {
        /* 150+ 行 */
    }
}
```

### 代码质量

- 关键代码需要解释性注释
- 超过 100 行的函数必须重构
- 妥善处理异常和边缘情况
- 清晰一致的命名规范
- 禁止假设性代码 - 只交付完整实现

### TypeScript 规范

- 启用严格类型检查
- 避免使用 `any` - 使用 `unknown` 或正确的类型
- 对象类型优先使用 `interface` 而非 `type`
- 使用联合类型进行状态管理

## 项目结构

### Monorepo 设置（pnpm workspace）

```
zouwu-workflow/
├── packages/
│   ├── @systembug/zouwu-workflow/
│   └── ...
├── pnpm-workspace.yaml
└── package.json
```

### 关键规则

- 修改前检查包依赖关系
- 共享工具放在公共包中
- 禁止循环依赖
- 每个包必须有清晰的职责

## 测试要求

### 覆盖率

- 单元测试覆盖率：最低 80%
- 关键路径：要求 100% 覆盖
- 关键工作流需要集成测试

### 测试结构

```typescript
describe('功能模块', () => {
    it('应正确处理正常情况', () => {
        // Arrange - 准备
        // Act - 执行
        // Assert - 断言
    });

    it('应正确处理边界情况', () => {
        // 测试边界情况
    });

    it('应正确处理错误', () => {
        // 测试错误场景
    });
});
```

## Git 提交规范

### Conventional Commits

```
feat: 新功能
fix: 修复 bug
docs: 仅文档修改
refactor: 代码重构
test: 添加/更新测试
chore: 构建/工具变更
perf: 性能优化
```

### 提交信息格式

```
<类型>(<范围>): <主题>

<正文>

<页脚>
```

## 错误处理

### 自动暂停场景

1. AI 连续失败 2 次
2. 遇到不可恢复错误
3. 检测到高风险操作：
    - 数据库结构变更
    - 生产环境配置修改
    - 数据删除操作

### 恢复流程

1. 输出详细诊断信息
2. 等待用户确认
3. 用户可随时重定向或纠正

## 开发工作流

### 模式流程

研究 → 创新 → 规划 → 验证 → 执行 → 审查

### 智能模式触发

- 使用 `!!!` 触发单次完整流程
- AI 自动判断何时使用智能模式
- 复杂任务使用完整模式流程

## 关键规则

### 绝不允许

- 留下不完整的功能
- 使用未验证的依赖
- 跳过错误处理
- 创建假代码或占位符实现
- 用变通方案代替修复
- 修改无关代码
- 破坏现有功能

### 必须做到

- 修复根本原因，而非症状
- 编写完整可用的代码
- 测试关键路径
- 记录设计决策
- 遵循项目规范
- 执行前验证

## 性能标准

### 响应时间

- 常规交互：30 秒以内
- 复杂任务：提供进度更新
- 超时处理：优雅降级或拆分任务

### 代码效率

- 优化关键路径
- 避免不必要的迭代
- 使用合适的数据结构
- 优化前先分析

## 文档要求

### 代码注释

- 复杂逻辑必须解释
- 公共 API 需要 JSDoc
- 非显而易见的决策需要说明理由

### 项目文档

- 架构决策记录在 /docs
- 公共接口的 API 文档
- 安装和部署指南
- 版本发布日志

---

**记住**：直接、高效、零废话。用最少的代码解决问题。不过度设计。不伪造信息。
